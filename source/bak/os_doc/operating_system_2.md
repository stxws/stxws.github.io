---
title: '操作系统考研笔记(2)——进程管理'
date: 2021-08-04
categories: 考研
tags: [操作系统, 考研, 计算机]
mathjax: true
---


# 进程与线程

## 进程的概念和特征

### 进程的概念

比较典型的进程定义：

1. 进程是程序的一次执行过程。
2. 进程是一个程序及数据在处理机上顺序执行时所发生的活动。
3. 进程是具有独立功能的程序在一个数据集合上运行的过程，它是系统进行资源分配和调度的一个独立单位。

**进程控制块**：（Process Control Block，PCB）为了使进程能独立地并发运行，而专门配置的数据结构。

### 进程的特征

1. **动态性**。进程是程序的一次执行，它有着创建、活动、暂停、终止等过程，具有一定的生命周期，是动态产生、变化和消亡的。动态性是进程最基本的特征。
2. **并发性**。指多个进程实体同时存于内存中，能在一段时间内同时运行。并发性是进程的重要特征，同时也是操作系统的重要特征。引入进程的目的就是为了使程序能与其他进程的程序并发执行，一提高资源利用率。
3. **独立性**。指进程实体是一个能独立运行、独立获得资源和独立接受调度的基本单位。凡是未建立PCB的程序，都不能作为一个独立的单位参与运行。
4. **异步性**。由于进程的相互制约，使得进程具有执行的间断性，即进程按各自独立的、不可预知的速度向前推进。异步性会导致执行结果的不可再现性，为此在操作系统中必须配置相应的进程同步机制。
5. **结构性**。每个进程都配置一个PCB对其进行描述。从结构上看，进程实体是由程序段、数据段和进程控制块三部分组成的。

## 进程的状态与转换

&emsp;&emsp;通常进程有以下五种状态，前三种是进程的基本状态。

1. **运行态**。进程正在处理机上运行。在单处理机环境下，每个时刻最多只有一个进程处于运行态。
2. **就绪态**。进程获得了处理机外的一切所需资源，一旦得到处理机，便可立即运行。系统中处于就绪状态的进程可能有多个，通常将它们排成一个队列，称为就绪队列。
3. **阻塞态**。又称等待态。进程正在等待某一事件而暂停运行，如等待某资源为可用（不包括处理机）或等待输入/输出完成。即使处理机空闲，该进程也不能运行。
4. **创建态**。进程正在被创建，尚未转到就绪态。创建进程通常需要多个步骤：首先申请一个空白的PCB，并向PCB中填写一些控制和管理进程的信息；然后由系统为该进程分配运行时所需的资源；最后把该进程转入就绪态。
5. **结束态**。进程正在从系统中消失，可能是进程正常结束或其他原因中断退出运行。进程需要结束运行时，系统首先必须置改进程为结束态，然后再进一步处理资源释放和回收等工作。

&emsp;&emsp;注意区别就绪态和阻塞态：就绪态是指进程仅缺少处理机，只要获得处理机资源就立即运行；而阻塞态是指进程需要其他资源（除了处理机）或等待某一事件。之所以把处理机和其他资源划分开，是因为在分时系统的时间片轮转机制中，每个进程分到的时间片是若干毫秒，进程得到处理机的时间很短且非常频繁，进程在运行过程中实际上是频繁地转换到就绪态的；而其他资源（如外设）的使用和分配或某一事件的发生（如IO操作的完成）对应的时间相对来说很长，进程转换到等待态的次数也相对较少。

&emsp;&emsp;下图说明了进程5种状态的转换：

![](/images/learn_note/operating_system_2/fig_1.png)

- **就绪态 --> 运行态**：处于就绪态的进程被调度后，获得处理机资源（分配到了处理时间片），于是进程由就绪态转换为运行态。
- **运行态 --> 就绪态**：处于运行态的进程在时间片用完后，不得不让出处理机，从而进程由运行态转换为就绪态。此外，在可抢占的操作系统中，当有更高优先级的进程就绪时，调度程序将正在执行的进程转换为就绪态，让更高优先级的进程执行。
- **运行态 --> 阻塞态**：进程请求某一资源（如外设）的使用和分配或等待某一事件的发生（如IO操作的完成）时，它就从运行态转换为阻塞态。进程以系统调用的形式请求操作系统提供服务。
- **阻塞态 --> 就绪态**：进程等待的事件到来时，如IO操作结束或中断结束时，中断处理程序必须把相应进程的状态由阻塞态转换为就绪态。

&emsp;&emsp;一个进程从运行态变成阻塞态是主动行为，而从运行态变成就绪态是被动行为。


## 进程控制

&emsp;&emsp;进程控制的主要功能是对系统中的所有进程实施有效的管理，它具有创建新进程、撤销已有进程、实现进程状态装换等功能。在操作系统中，一般把进程控制用的程序段称为**原语**，原语的特点是执行期间不允许中断。

### 进程的创建

&emsp;&emsp;允许一个进程创建另一个进程。此时创建者称为`父进程`，被创建的进程称为`子进程`。子进程可以继承父进程所拥有的资源。当子进程被撤销时，应将其从父进程那里获得的资源归还给父进程。此外，在撤销父进程时，必须同时撤销其所有的子进程。

操作系统创建一个新进程的过程如下（创建原语）：
1. 为新进程分配一个唯一的进程标识号，并申请一个空白的PCB（PCB是有限的）。若PCB申请失败，则创建失败。
2. 为进程分配资源，为新进程的程序和数据及用户栈分配必要的内存空间（在PCB中体现）。若资源不足（如内存空间），则并不是创建失败，而是处于阻塞态，等待内存资源。
3. 初始化PCB，主要包括初始化标志信息、初始化处理机状态信息和初始化处理机控制信息，以及设置进程的优先级等。
4. 若进程就绪队列能够接纳新进程，则将新进程插入就绪队列，等待被调度运行。

### 进程的终止

引起进程终止的事件：

1. 正常结束，表示进程的任务已完成并准备退出运行。
2. 异常退出，表示进程在运行时，发生了某种异常事件，使程序无法继续运行。
3. 外界干预，指进程应外界的请求而终止运行，如操作员或操作系统干预、父进程请求和父进程终止。

操作系统终止进程的过程（撤销原语）：

1. 根据被终止进程的标识符，检索PCB，从中读出该进程的状态。
2. 若被终止进程处于执行状态，立即终止该进程的执行，将处理机资源分配给其他进程。
3. 若该进程还有子孙进程，则应将其所有子孙进程终止。
4. 将该进程所拥有的全部资源，或归还给其父进程，或归还给操作系统。
5. 将该PCB从所在队列中删除。

### 进程的阻塞和唤醒

阻塞原语的执行过程：

1. 找到要被阻塞进程的标识号对应的PCB。
2. 若进程为运行态，则保护其现场，将处理机资源调度给其他就绪进程。
3. 把该PCB插入相应事件的等待队列，将处理机资源调度给其他就绪进程。

唤醒原语的执行过程：

1. 在该事件的等待队列中找到相应进程的PCB。
2. 将其从等待队列中移出，并置其状态为就绪态。
3. 把该PCB插入就绪队列，等待调度程序调度。

### 进程切换

进程切换的过程：

1. 保存处理机上下文，包括程序计数器和其他寄存器。
2. 更新PCB信息。
3. 把进程的PCB移入相应的队列，并更新其PCB。
4. 选择另一个进程执行，并更新其PCB。
5. 更新内存管理的数据结构。
6. 恢复处理机上下文。

&emsp;&emsp;注意`调度`和`切换`的区别。调度是指决定资源分配给哪个进程的行为，是一种决策行为；切换是指实际分配的行为，是执行行为。一般来说，先有资源的调度，然后才有进程的切换。


## 进程的组织

&emsp;&emsp;进程是一个独立运行单位，也是操作系统进行资源分配和调度的基本单位。它由以下三部分组成，其中最核心的是进程控制块（PCB）。

### 进程控制块

&emsp;&emsp;进程创建时，操作系统为它新建一个PCB，该结构之后常驻内存，任意时刻都可以存取，并在进程结束时删除。PCB是进程实体的一部分，是进程存在的唯一标志。
&emsp;&emsp;进程执行时，系统通过其PCB了解进程的现行状态信息，以便对其进行控制和管理；进程结束时，系统收回其PCB，该进程随之消亡。操作系统通过PCB表来管理和控制进程。
&emsp;&emsp;当操作系统欲调度某进程运行时，要从该进程的PCB中查出其现行状态及优先级；在调度到某进程后，需要根据其PCB中所保存的处理机状态信息，设置该进程恢复运行的现场，并根据其PCB中的程序和数据的内存地址，找到其程序和数据；进程在运行过程中，当需要和与之合作的进程实现同步、通信或访问文件时，也需要访问PCB；当进程由于某种原因而暂停运行时，又需将其断点的处理机环境保存在PCB中。
&emsp;&emsp;在进程的整个生命期中，系统总是通过PCB对进程进行控制的，亦即系统唯有通过进程的PCB才能感知到该进程的存在。

PCB通常包含的内容：

| 进程描述信息 | 进程控制和管理信息 | 资源分配清单 | 处理机相关信息 |
| :---: | :---: | :---: | :---: |
| 进程标识符（PID） | 进程当前状态 | 代码段指针 | 通用寄存器值 |
| 用户标识符（UID） | 进程优先级 | 数据段指针 | 地址寄存器值 |
|  | 代码运行入口地址 | 堆栈段指针 | 控制寄存器值 |
|  | 程序的外存地址 | 文件描述符 | 标志寄存器值 |
|  | 进入内存的时间 | 键盘 | 状态字 |
|  | 处理机占用时间 | 鼠标 |  |
|  | 信号量使用 |  |  |

进程描述信息：

1. 进程标识符：标志各个进程，每个进程都有一个唯一的标识符。
2. 用户标识符：进程归属的用户，用户标识符主要为共享和保护服务。

进程控制和管理信息：

1. 进程当前状态：描述进程的状态信息，作为处理机分配调度的依据。
2. 进程优先级：描述进程抢占处理机的优先级，优先级高的进程可优先获得处理机。

资源分配清单：用于说明有关内存地址空间或虚拟地址空间的状况，所打开文件的列表和所使用的输入输出设备信息。

处理机相关信息：主要指处理机中各寄存器的值，当进程被切换时，处理机状态信息都必须保存在相应的PCB中，以便在该进程重新执行时，能从断点继续执行。

### 程序段

&emsp;&emsp;程序段就是能被进程调度程序调度到CPU执行的程序代码段。程序可被多个进程共享，即多个进程可以运行同一个程序。

### 数据段

&emsp;&emsp;一个进程的数据段，可以是进程对应的程序加工处理的原始数据，也可以是程序执行时产生的中间或最终结果。

## 进程的通信

### 共享存储

&emsp;&emsp;在通信的进程之间存在一块可直接访问的共享空间，通过对这片共享空间进行写/读操作实现进程之间的信息交换。在对共享空间进行写/读操作时，需要使用同步互斥工具（如P操作、V操作），对共享空间的写/读进行控制。共享存储分为两种：低级方式的共享是基于数据结构的共享；高级方式的共享则是基于存储区的共享。操作系统只负责为通信进程提供可共享使用的存储空间和同步互斥工具，而数据交换则由用户自己安排读/写指令完成。

### 消息传递

&emsp;&emsp;在消息传递系统中，进程间的数据交换是以格式化的消息为单位的。进程通过系统提供的发送消息和接收消息两个原语进行数据交换。

1. 直接通信方式。发送进程直接把消息发送给接收进程，并将它挂在接收进程的消息缓冲队列上，接收进程从消息缓冲队列中取得消息。
2. 间接通信方式。发送进程把消息发送到某个中间实体，接收进程从中间实体取得消息。这种中间实体一般称为`信箱`，这种通信方式又称`信箱通信方式`。该通信方式广泛应用于计算机网络中，相应的通信系统称为`电子邮件系统`。

### 管道通信

&emsp;&emsp;`管道`是指用于连接一个读进程和一个写进程以实现它们之间通信的一个共享文件，又名pipe文件。向管道提供输入的发送进程（即写进程），以字符流形式将大量数据送入（写）管道；而接收管道输出的接收进程（即读进程）则从管道中接收（读）数据。为了协调双方的通信，管道机制必须提供三方面的协调能力：互斥、同步和确定对方的存在。

&emsp;&emsp;从管道读数据是一次性操作，数据一旦被读取，它就从管道中被抛弃，释放空间以便写更多的数据。管道只能采用半双工通信，即某一时刻只能单向传输。要实现进程双方互动通信，需要定义两个管道。

## 线程概念和多线程模型

### 线程的基本概念

&emsp;&emsp;`线程`最直接的理解就是"轻量级进程"，它是一个基本的CPU执行单元，也是程序执行流的最小单元，由线程ID、程序计数器、寄存器集合和堆栈组成。线程是进程中的一个实体，是被系统独立调度和分派的基本单位，线程自己不拥有系统资源，只拥有一点儿在运行中必不可少的资源，但它可与同属一个进程的其他线程共享进程所拥有的全部资源。一个线程可以创建和撤销另一个线程，同一个进程中的多个线程之间可以并发执行。由于线程之间的相互制约，致使线程在运行中呈现出间断性。线程也有就绪、阻塞和运行三种基本状态。

&emsp;&emsp;引入线程后，进程的内涵发生了改变，进程只作为除CPU外的系统资源分配单元，而线程则作为处理机的分配单元。由于一个进程内部有多个线程，若线程的切换发生在同一个进程内部，则只需要很少的时空开销。

### 线程与进程的比较

1. 调度。在传统的操作系统中，拥有资源和独立调度的基本单位都是进程。在引入线程的操作系统中，线程是独立调度的基本单位，进程是拥有资源的基本单位。
2. 拥有资源。不论是传统操作系统还是设有线程的操作系统，进程都是拥有资源的基本单位，而线程不拥有系统资源（也有一点必不可少的资源），但线程可以访问其隶属进程的系统资源。
3. 并发性。在引入线程的操作系统中，不仅进程之间可以并发执行，而且多个线程之间也可以并发执行，从而使操作系统具有更好的并发性，提高了系统的吞吐量。
4. 系统开销。由于创建或撤销进程时，系统都要为之分配或回收资源，如内存空间、IO设备等，因此操作系统所付出的开销远大于创建或撤销线程时的开销。类似地，在进行进程切换时，涉及当前执行进程CPU环境的保存及新调度到进程CPU环境的设置，而线程切换时只需保存和设置少量寄存器内容，开销很小。此外，由于同一进程内的多个线程共享进程的地址空间，因此这些线程之间的同步与通信非常容易实现，甚至无须操作系统的干预。
5. 地址空间和其他资源。进程的地址空间之间互相独立，同一进程的各线程间共享进程的资源，某进程内的线程对于其他进程不可见。
6. 通信方面。进程间通信（IPC）需要进程同步和互斥手段的辅助，以保证数据的一致性，而线程间可以直接读/写进程数据段（如全局变量）来进行通信。

### 线程的属性

1. 线程是一个轻型实体，它不拥有系统资源，但每个线程都应有一个唯一的标识符和一个线程控制块，线程控制块记录了线程执行的寄存器和栈等现场状态。
2. 不同的线程可以执行相同的程序，即同一个服务程序被不同的用户调用时，操作系统把它们创建成不同的线程。
3. 同一个进程中的各个线程共享该进程所拥有的资源。
4. 线程是处理机的独立调度单位，多个线程是可以并发执行的。
5. 一个线程被创建后，便开始了它的生命周期，直至终止。线程在生命周期内会经历阻塞态、就绪态和运行态等各种状态变化。

### 线程的实现方式

&emsp;&emsp;线程的实现可以分为两类：`用户级线程`（User-Level Thread，ULT）和`内核级线程`（Kernel-Level Thread，KLT），内核级线程又称`内核支持的线程`。

&emsp;&emsp;在用户级线程中，有关线程管理（线程的创建、撤销和切换等）的所有工作都由应用程序完成，内核意识不到线程的存在。应用程序可以通过使用线程库设计成多线程程序。
&emsp;&emsp;在内核级线程中，线程管理的所有工作由内核完成，应用程序没有进行线程管理的代码，只有一个到内核级线程的编程接口。内核为进程及其内部的每个线程维护上下文信息，调度也在内核基于线程架构的基础上完成。
&emsp;&emsp;有些系统中使用组合方式的多线程实现。线程的创建完全在用户空间中完成，线程的调度和同步也在应用程序中进行。一个应用程序中的多个用户级线程被映射到一些（小于等于用户级线程的数目）内核级线程上。

![](/images/learn_note/operating_system_2/fig_2.png)

### 多线程模型

1. **多对一模型**。将多个用户级线程映射到一个内核级线程，线程管理在用户空间完成。此模式中，用户级对操作系统不可见（即透明）。
	- 优点：线程管理是在用户空间进行的，因而效率比较高。
	- 缺点：一个线程在使用内核服务时被阻塞，整个进程都会被阻塞；多个线程不能并行地运行在多处理机上
2. **一对一模型**。将每个用户级线程映射到一个内核级线程。
	- 优点：当一个线程被阻塞后，允许另一个线程继续执行，所以并发能力较强。
	- 缺点：每创建一个用户级线程都需要创建一个内核级线程与其对应，这样创建线程的开销比较大，会影响到应用程序的性能。
3. **多对多模型**。将n个用户级线程映射到m个内核级线程上，要求$m \leq n$。
	- 特点：多对多模型是多对一模型和一对一模型的折中，即克服了多对一模型并发度不高的缺点，又克服了一对一模型的一个用户进程占用太多内核级线程而开销太大的缺点。此外，还拥有多对一模型和一对一模型各自的优点。


# 处理机调度

## 调度的概念

### 调度的基本概念
 
&emsp;&emsp;处理机调度是对处理机进行分配，即从就绪队列中按照一定的算法（公平＼高效）选择一个进程，并将处理机分配给它运行，以实现进程并发地执行。

### 调度的层次

1. **作业调度**。又称高级调度，其主要任务是按一定的原则从外存上处于后备状态的作业中挑选一个（或多个）作业，给它们分配内存、输入/输出设备等必要的资源，并建立相应的进程，以使它们获得竞争处理机的权利。作业调度是内存与辅存之间的调度。对于每个作业只调入一次、调出一次。
2. **中级调度**。又称内存调度，其作用是提高内存利用率和系统吞吐量。为此，应将那些暂时不能运行的进程调至外存等待，把此时的进程状态称为`挂起态`。当它们已具备运行条件且内存又稍有空闲时，由中级调度来决定把外存上那些已具备运行条件的就绪进程，再重新调入内存，并修改其状态为就绪态，挂在就绪队列上等待。